

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pymer4.models &mdash; pymer4 0.2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="pymer4 0.2.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pymer4
          

          
          </a>

          
            
            
              <div class="version">
                0.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Basic Usage Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../categorical.html">Categorical Predictors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rfx_cheatsheet.html">Lme4 Random Effects Cheat Sheet</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#pymer4-models-model-classes"><code class="docutils literal"><span class="pre">pymer4.models</span></code>: Model Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#module-pymer4.utils"><code class="docutils literal"><span class="pre">pymer4.utils</span></code>: Utilities</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pymer4</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pymer4.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pymer4.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
<span class="kn">import</span> <span class="nn">rpy2</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<div class="viewcode-block" id="Lmer"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer">[docs]</a><span class="k">class</span> <span class="nc">Lmer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class to hold data outputted from fitting lmer in R and converting to Python object. This class stores as much information as it can about a merMod object computed using lmer and lmerTest in R. Most attributes will not be computed until the fit method is called.</span>

<span class="sd">    Args:</span>
<span class="sd">        formula (str): Complete lmer-style model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): input data</span>
<span class="sd">        family (string): what distribution family (i.e.) link function to use for the generalized model; default is gaussian (linear model)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted (bool): whether model has been fit</span>
<span class="sd">        formula (str): model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): model copy of input data</span>
<span class="sd">        ngrps (float): number of groups recognized by lmer</span>
<span class="sd">        AIC (float): model akaike information criterion</span>
<span class="sd">        logLike (float): model Log-likelihood</span>
<span class="sd">        family (string): model family</span>
<span class="sd">        ranef (pandas.core.frame.DataFrame): cluster-level differences from population parameters, i.e. difference between coefs and fixefs</span>
<span class="sd">        fixef (pandas.core.frame.DataFrame): cluster-level parameters</span>
<span class="sd">        coefs (pandas.core.frame.DataFrame): model summary table of population parameters</span>
<span class="sd">        resid (numpy.ndarray): model residuals</span>
<span class="sd">        fits (numpy.ndarray): model fits/predictions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">formula</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>


        <span class="n">implemented_fams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span><span class="s1">&#39;binomial&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">implemented_fams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Currently only linear (family =&#39;gaussian&#39;) and logisitic (family=&#39;binomial&#39;) models supported! &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">(fitted=</span><span class="si">{}</span><span class="s2">,formula=</span><span class="si">{}</span><span class="s2">,family=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_sig_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds sig stars to coef table prettier output.&quot;&quot;&quot;</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">001</span><span class="p">:</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;***&#39;</span>
        <span class="k">elif</span> <span class="o">.</span><span class="mi">001</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;**&#39;</span>
        <span class="k">elif</span> <span class="o">.</span><span class="mi">01</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">05</span><span class="p">:</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">elif</span> <span class="o">.</span><span class="mi">05</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">return</span> <span class="n">star</span>

    <span class="k">def</span> <span class="nf">_make_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">factor_dict</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covert specific columns to R-style factors. Default scheme is dummy coding where reference is 1st level provided. Alternative is orthogonal polynomial contrasts</span>

<span class="sd">        Args:</span>
<span class="sd">            factor_dict: (dict) dictionary with column names specified as keys, and lists of unique values to treat as factor levels</span>
<span class="sd">            ordered: (bool) whether to interpret factor_dict values as dummy-coded (1st list item is reference level) or as polynomial contrasts (linear contrast specified by ordered of list items)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.core.frame.DataFrame: copy of original data with factorized columns</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">ordered</span><span class="p">:</span>

            <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                function(df,f,lv){</span>
<span class="s2">                df[,f] &lt;- factor(df[,f],lv,ordered=T)</span>
<span class="s2">                df</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(df,f,lv){</span>
<span class="s2">            df[,f] &lt;- factor(df[,f],lv,ordered=F)</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">factorize</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">factor_dict</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">r_df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">factor_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

            <span class="n">r_df</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">r_df</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r_df</span>

    <span class="k">def</span> <span class="nf">anova</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot; ANOVA tables coming soon!&quot;</span><span class="p">)</span>

        <span class="c1">#TODO Make sure factors are set with orthogonal contrasts first</span>
        <span class="sd">&quot;&quot;&quot;Compute a Type III ANOVA table on a fitted model.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Model hasn&#39;t been fit! Call fit() method before computing ANOVA table.&quot;</span>

        <span class="c1">#See rpy2 for building contrasts or loop and construct rstring</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            df&lt;- anova(model)</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">anova</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anova</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">anova</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SS&#39;</span><span class="p">,</span><span class="s1">&#39;MS&#39;</span><span class="p">,</span><span class="s1">&#39;NumDF&#39;</span><span class="p">,</span><span class="s1">&#39;DenomDF&#39;</span><span class="p">,</span><span class="s1">&#39;F-stat&#39;</span><span class="p">,</span><span class="s1">&#39;P-val&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="p">[</span><span class="s1">&#39;P-val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DF&#39;</span><span class="p">,</span><span class="s1">&#39;SS&#39;</span><span class="p">,</span><span class="s1">&#39;MS&#39;</span><span class="p">,</span><span class="s1">&#39;F-stat&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analysis of variance Table of type III with Satterthwaite approximated degrees of freedom:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova</span>


<div class="viewcode-block" id="Lmer.fit"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conf_int</span><span class="o">=</span><span class="s1">&#39;Wald&#39;</span><span class="p">,</span><span class="n">factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main method for fitting model object. Will modify the model&#39;s data attribute to add columns for residuals and fits for convenience.</span>

<span class="sd">        Args:</span>
<span class="sd">            conf_int (str): which method to compute confidence intervals; &#39;profile&#39;, &#39;Wald&#39; (default), or &#39;boot&#39; (parametric bootstrap)</span>
<span class="sd">            factors (dict): col names (keys) to treat as dummy-coded factors with levels specified by unique values (vals). First level is always reference, e.g. {&#39;Col1&#39;:[&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]}</span>
<span class="sd">            ordered (bool): whether factors should be treated as ordered polynomial contrasts; this will parameterize a model with K-1 orthogonal polynomial regressors beginning with a linear contrast based on the factor order provided; default is False</span>
<span class="sd">            summarize (bool): whether to print a model summary after fitting; default is True</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe: R style summary() table</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span><span class="n">ordered</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="n">factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting linear model using lmer with &quot;</span><span class="o">+</span><span class="n">conf_int</span><span class="o">+</span><span class="s2">&quot; confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;lmerTest&#39;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting generalized linear model using glmer with &quot;</span><span class="o">+</span><span class="n">conf_int</span><span class="o">+</span><span class="s2">&quot; confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;lme4&#39;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>

        <span class="n">base</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">unsum</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">unclass</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="c1">#Do scalars first cause they&#39;re easier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;ngrps&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;AICtab&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;logLik&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#First check for lme4 printed messages (e.g. convergence info is usually here instead of in warnings)</span>
        <span class="n">fit_messages</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;optinfo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;lme4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">)</span>
        <span class="c1">#Then check warnings for additional stuff</span>
        <span class="n">fit_warnings</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;optinfo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;warnings&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_warnings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fit_warnings</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_messages</span><span class="p">,</span><span class="n">rpy2</span><span class="o">.</span><span class="n">rinterface</span><span class="o">.</span><span class="n">RNULLType</span><span class="p">):</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fit_messages</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fit_messages_warnings</span> <span class="o">=</span> <span class="n">fit_messages</span> <span class="o">+</span> <span class="n">fit_warnings</span>
        <span class="k">if</span> <span class="n">fit_messages_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="n">fit_messages_warnings</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">warning</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#Random effect variances and correlations</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s1">&#39;varcor&#39;</span><span class="p">)))</span>
        <span class="n">ran_vars</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(var2 == &#39;NA&#39;) | (var2 == &#39;N&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;var2&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_vars</span><span class="p">[</span><span class="s1">&#39;grp&#39;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Var&#39;</span><span class="p">,</span><span class="s1">&#39;Std&#39;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ran_corrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(var2 != &#39;NA&#39;) &amp; (var2 != &#39;N&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;vcov&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ran_corrs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_corrs</span><span class="p">[</span><span class="s1">&#39;grp&#39;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IV1&#39;</span><span class="p">,</span><span class="s1">&#39;IV2&#39;</span><span class="p">,</span><span class="s1">&#39;Corr&#39;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_corrs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="n">ran_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="n">ran_corrs</span>

        <span class="c1"># TODO Parse and store fixed effects correlation matrix +enhancement id:2 gh:11</span>

        <span class="c1">#Cluster (e.g subject) level coefficients</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- coef(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fixef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">fixef_func</span><span class="p">(</span><span class="n">model</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1">#Cluster (e.g subject) level random deviations</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            uniquify &lt;- function(df){</span>
<span class="s2">            colnames(df) &lt;- make.unique(colnames(df))</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">            out &lt;- lapply(ranef(model),uniquify)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">ranef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">ranef_func</span><span class="p">(</span><span class="n">model</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1">#Save the design matrix</span>
        <span class="c1">#Make sure column names match fixef and ranef dataframes (why is R so frustrating!!!)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">columns</span><span class="p">[:]</span>

        <span class="c1">#Model residuals</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- resid(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">resid_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">resid_func</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>

        <span class="c1">#Model fits</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- fitted(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fit_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">fit_func</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="p">)</span>

        <span class="c1">#Coefficients, and inference statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>

            <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                function(model){</span>
<span class="s2">                out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="s2">                out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span><span class="o">+</span><span class="n">conf_int</span><span class="o">+</span><span class="s2">&quot;&quot;&quot;&#39;))</span>
<span class="s2">                n &lt;- c(rownames(out.ci))</span>
<span class="s2">                idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                out</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">estimates_func</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;DF&#39;</span><span class="p">,</span><span class="s1">&#39;T-stat&#39;</span><span class="p">,</span><span class="s1">&#39;P-val&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;DF&#39;</span><span class="p">,</span><span class="s1">&#39;T-stat&#39;</span><span class="p">,</span><span class="s1">&#39;P-val&#39;</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1">#Incase lmerTest chokes it won&#39;t return p-values</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;T-stat&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;T-stat&#39;</span><span class="p">]]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s1">&#39;binomial&#39;</span><span class="p">:</span>

            <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                function(model){</span>
<span class="s2">                out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="s2">                out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span><span class="o">+</span><span class="n">conf_int</span><span class="o">+</span><span class="s2">&quot;&quot;&quot;&#39;))</span>
<span class="s2">                n &lt;- c(rownames(out.ci))</span>
<span class="s2">                idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                odds &lt;- exp(out.coef[1])</span>
<span class="s2">                colnames(odds) &lt;- &quot;OR&quot;</span>
<span class="s2">                probs &lt;- data.frame(sapply(out.coef[1],plogis))</span>
<span class="s2">                colnames(probs) &lt;- &quot;Prob&quot;</span>
<span class="s2">                odds.ci &lt;- exp(out.ci)</span>
<span class="s2">                colnames(odds.ci) &lt;- c(&quot;OR_2.5_ci&quot;,&quot;OR_97.5_ci&quot;)</span>
<span class="s2">                probs.ci &lt;- data.frame(sapply(out.ci,plogis))</span>
<span class="s2">                colnames(probs.ci) &lt;- c(&quot;Prob_2.5_ci&quot;,&quot;Prob_97.5_ci&quot;)</span>
<span class="s2">                out &lt;- cbind(out,odds,odds.ci,probs,probs.ci)</span>
<span class="s2">                out</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">estimates_func</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;Z-stat&#39;</span><span class="p">,</span><span class="s1">&#39;P-val&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;OR&#39;</span><span class="p">,</span><span class="s1">&#39;OR_2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;OR_97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;Prob&#39;</span><span class="p">,</span><span class="s1">&#39;Prob_2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;Prob_97.5_ci&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;OR&#39;</span><span class="p">,</span><span class="s1">&#39;OR_2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;OR_97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;Prob&#39;</span><span class="p">,</span><span class="s1">&#39;Prob_2.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;Prob_97.5_ci&#39;</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;Z-stat&#39;</span><span class="p">,</span><span class="s1">&#39;P-val&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s1">&#39;P-val&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;P-val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO: Add group names when printing number of groups +enhancement id:1 gh:10</span>
        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of groups: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrps</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Log-likelihood: </span><span class="si">%.3f</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> AIC: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">AIC</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No random effect correlations specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixed effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="Lmer.plot"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">plot_fixef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">grps</span><span class="o">=</span><span class="p">[],</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot random and group level parameters from a fitted model</span>

<span class="sd">        Args:</span>
<span class="sd">            param (str): model parameter (column name) to plot conditioned at mean of all other model params</span>
<span class="sd">            figsize (tup): matplotlib desired figsize</span>
<span class="sd">            xlabel (str): x-axis label</span>
<span class="sd">            ylabel (str): y-axis label</span>
<span class="sd">            plot_fixef (bool): plot population effect fit of param?; default True</span>
<span class="sd">            plot_ci (bool): plot computed ci&#39;s of population effect?; default True</span>
<span class="sd">            grps (list): plot specific group fits only; must correspond to index values in model.fixef</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure handle, matplotlib axis handle</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span> <span class="s2">&quot;Model must be fit before plotting!&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">);</span>

        <span class="c1">#Get range of unique values for desired parameter</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#Sort order to handle bug in matplotlib plotting</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

        <span class="c1">#Get all other variables in G, excluding intercept</span>
        <span class="n">other_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">,</span><span class="n">param</span><span class="p">]]</span>
        <span class="c1">#Get mean values for other vals to make conditional predictions</span>
        <span class="n">other_vals_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[</span><span class="n">other_vals</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#Generate group effects predictions first</span>
        <span class="c1">#Prediction = Intercept + coef * desired_param_value_range + coef_2 * other_param_held_at_mean ....</span>

        <span class="c1">#Get desired parameter part of the prediction</span>
        <span class="n">fixef_desired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">,</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">x_vals</span>
        <span class="n">fixef_desired_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">x_vals</span>
        <span class="n">fixef_desired_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">x_vals</span>


        <span class="c1">#Get other parameters part of the prediction, held at their mean value</span>
        <span class="n">fixef_other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">other_vals_means</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_vals</span><span class="p">,</span><span class="s1">&#39;Estimate&#39;</span><span class="p">])</span>
        <span class="n">fixef_other_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">other_vals_means</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_vals</span><span class="p">,</span><span class="s1">&#39;2.5_ci&#39;</span><span class="p">])</span>
        <span class="n">fixef_other_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">other_vals_means</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_vals</span><span class="p">,</span><span class="s1">&#39;97.5_ci&#39;</span><span class="p">])</span>

        <span class="c1">#Add them together for conditional prediction</span>
        <span class="n">fixef_pred</span> <span class="o">=</span> <span class="n">fixef_desired</span> <span class="o">+</span> <span class="n">fixef_other</span>
        <span class="n">fixef_pred_upper</span> <span class="o">=</span> <span class="n">fixef_desired_upper</span> <span class="o">+</span> <span class="n">fixef_other_upper</span>
        <span class="n">fixef_pred_lower</span> <span class="o">=</span> <span class="n">fixef_desired_lower</span> <span class="o">+</span> <span class="n">fixef_other_lower</span>

        <span class="k">if</span> <span class="n">grps</span><span class="p">:</span>
            <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grps</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>

        <span class="c1">#Now generate random effects predictions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ran_dat</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">ranef_desired</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">*</span><span class="n">x_vals</span>
            <span class="n">ranef_other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">other_vals_means</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_vals</span><span class="p">])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">ranef_desired</span> <span class="o">+</span> <span class="n">ranef_other</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">plot_fixef</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">fixef_pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">9999999</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">plot_ci</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">fixef_pred_lower</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">fixef_pred_upper</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">9999998</span><span class="p">);</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
               <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
               <span class="n">xlabel</span> <span class="o">=</span> <span class="n">param</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">ax</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Eshin Jolly.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>